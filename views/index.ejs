<!DOCTYPE html>
<html lang="en">
<head>
    <title>Weather</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <h4 class="profile"><%=email%></h4>
        <input style="display:none" id="fav" type="text" value="<%=fav%>" readonly>
        <nav class="nav-bar">
            <a href="/logout" class="login-btn" style="text-decoration: none;">Logout</a>
        </nav>
        <h1> Weather </h1>
        <div class="card fav">
            <h2 class="weather">Favorite Place</h2>
            <h3 class="weather" id="fav-place">Loading...</h3>
            <p class="minValues" id="fav-temp">Loading...</p>
        </div>
        <img src="./images/cloud.png"/>
        <form id="form">
            <input placeholder="Enter the city" type="text" name="city" id="city" autocomplete="off" autocapitalize="on" autofocus="on"/>
            <input type="submit" id="btn" value="Get">
        </form>
        <h1 id="loc" style="visibility: hidden">Location</h1>
        <div class="forecast" id="forecast" style="visibility: hidden">
            <div class="card">
                <div id="iconsContainer">
                    <div class="icons">
                        <h4 class="weather" id="day1"></h4>
                        <div class="image">
                            <img src="dots.png" class="imgClass" id="img1" alt="">
                        </div>
                        <p class="minValues" id="day1Min">...</p>
                        <p class="maxValues" id="day1Max">...</p>
                    </div>
                </div>
            </div>
            <div class="card">
                <div id="iconsContainer">
                    <div class="icons">
                        <h4 class="weather" id="day2"></h4>
                        <div class="image">
                            <img src="dots.png" class="imgClass" id="img2">
                        </div>
                        <p class="minValues" id="day2Min">...</p>
                        <p class="maxValues" id="day2Max">...</p>
                    </div>
                </div>
            </div>
            <div class="card">
                <div id="iconsContainer">
                    <div class="icons">
                        <h4 class="weather" id="day3"></h4>
                        <div class="image">
                            <img src="dots.png" class="imgClass" id="img3">
                        </div>
                        <p class="minValues" id="day3Min">...</p>
                        <p class="maxValues" id="day3Max">...</p>
                    </div>
                </div>
            </div>
            <div class="card">
                <div id="iconsContainer">
                    <div class="icons">
                        <h4 class="weather" id="day4"></h4>
                        <div class="image">
                            <img src="dots.png" class="imgClass" id="img4">
                        </div>
                        <p class="minValues" id="day4Min">...</p>
                        <p class="maxValues" id="day4Max">...</p>
                    </div>
                </div>
            </div>
            <div class="card">
                <div id="iconsContainer">
                    <div class="icons">
                        <h4 class="weather" id="day5"></h4>
                        <div class="image">
                            <img src="dots.png" class="imgClass" id="img5">
                        </div>
                        <p class="minValues" id="day5Min">...</p>
                        <p class="maxValues" id="day5Max">...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', ()=>{
  const apiKey = '4d7d0912d819bc8ea0e6661d1cc2b571';
    const city = document.getElementById('fav').value;
  const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`;  
  fetch(url)
      .then(res => res.json())
      .then(data => {
          document.getElementById('fav-place').innerHTML = data.name;
          document.getElementById('fav-temp').innerHTML = 'Temp : '+ data.main.temp;
          console.log(data)
      }).catch(error => console.log(error));
})

const form = document.querySelector('form')

form.addEventListener('submit', (e) => {
  e.preventDefault();
  const apiKey = '4d7d0912d819bc8ea0e6661d1cc2b571';
    const city = document.getElementById('city').value;
    const url = `https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}`;
    const forecast = document.getElementById("forecast")
    const loc = document.getElementById('loc')

    fetch(url)
        .then(res => res.json())
        .then(data => {
              for(i=0;i<5;i++){
                document.getElementById("day" +(i+1)+"Min").innerHTML = "Min : "+ Number(data.list[i].main.temp_min -273.15).toFixed(1)+" deg";
              }
              for(i=0;i<5;i++){
                document.getElementById("day" +(i+1)+"Max").innerHTML = "Max : "+ Number(data.list[i].main.temp_max -273.15).toFixed(1)+" deg";
              }
              for(i=0;i<5;i++){
                document.getElementById("img" +(i+1)).src = "http://openweathermap.org/img/wn/"+data.list[i].weather[0].icon+".png";
              }
              document.getElementById('loc').innerHTML = data.city.name;
              forecast.style.visibility = "visible";
              loc.style.visibility = "visible";
              Notification.requestPermission().then(permission => {
                if(permission === 'granted'){
                  new Notification("Weather Forecast",
                    {
                      body: `The current temperature in ${(data.city.name).toUpperCase()} is ${((data.list[0].main.temp_min) - 273.15).toFixed(1)+"Â°C"}`,
                      icon:"/images/cloud2.png"
                    }
                  )
                }
              })
            console.log(data)
        }).catch(error => console.log(error));
        document.getElementById('city').value = ""
        const d = new Date()
        const weekday = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
        function checkDay(day){
            if(day + d.getDay > 7){
                return (day + d.getDay()) % 7;
            }else{
                return day + d.getDay();
            }
        }
        for(i=0;i<5;i++){
            document.getElementById("day"+(i+1)).innerHTML = weekday[checkDay(i)];
        }
})
    </script>
</body>
</html>